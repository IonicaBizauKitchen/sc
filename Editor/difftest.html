<!doctype html>
<title>Diff</title>
<meta charset=utf-8>

<p id=main>
<table>
  <tr>
    <td><textarea id=t0></textarea>
    <td><textarea id=t1></textarea>
  </tr>
  <tr>
    <td><button id=t0but>Push</button>
    <td><button id=t1but>Push</button>
  </tr>
</table>

<script src=js/diff_match_patch_uncompressed.js></script>
<script src=js/diff.js></script>

<script>

window.INITREV = 0;
window.COPY = '';
window.id = 0;

window.server = (function () {

  var rev = INITREV;
  var copy = COPY;

  return function (theirrev, delta, callback) {
  };

})();


/* Send the data to the server. Hold the state. */
window.client = (function () {

  var id = id++;

  var rev = INITREV;
  var lastcopy = COPY;
  var delta = [];

  /* Dom. */
  var text = document.getElementById('t'+id);

  return function (e) {
    /* Send the delta to the server. */

    var dmp = new diff_match_patch();
    var diff = dmp.diff_main(lastcopy, text.textContent);
    delta = Diff.delta(diff);
    var buffercopy = text.textContent;

    server(rev, delta, function (res) {
      delta = [];
      lastcopy = buffercopy;
      var dmp = new diff_match_patch();
      delta = Diff.solve(Diff.diff(dmp.diff_main(lastcopy, text.textContent)),
          res);
      text.innerHTML = Diff.applydelta(delta, text.textContent);
    });
  };

});

document.getElementById('t0but').addEventListener('click', client(), false);
document.getElementById('t1but').addEventListener('click', client(), false);
</script>
